/************************************************************************/
/* Xl1Sim: Talking Technology ADPCM simulator         V1.3    09/15/90  */
/* Copyright (c) 1987-1991 Andrew J. Michalik                           */
/*                                                                      */
/************************************************************************/
#include "visdef.h"                     /* Standard type definitions    */
#include "..\genpcm.h"                  /* PCM conversion routine hdr   */
#include "xltsim.h"                     /* Translation simulator defs   */

#include <stdlib.h>                     /* Misc string/math/error funcs */

/************************************************************************/
/************************************************************************/
#define STPTABSIZ   128


/************************************************************************/
/************************************************************************/
short   StpTab[STPTABSIZ] =
    { 4,     4,     4,     4,     5,     5,     5,     5,
      5,     5,     6,     6,     6,     6,     6,     7,
      7,     7,     7,     7,     8,     8,     8,     8,
      9,     9,     9,    10,    10,    10,    11,    11,
     11,    12,    12,    13,    13,    13,    14,    14,
     15,    15,    16,    16,    17,    17,    18,    19,
     19,    20,    21,    21,    22,    23,    23,    24,
     25,    26,    27,    28,    28,    29,    30,    31,
     32,    34,    35,    36,    37,    38,    40,    41,
     42,    44,    45,    47,    48,    50,    51,    53,
     55,    57,    59,    60,    62,    65,    67,    69,
     71,    74,    76,    79,    81,    84,    87,    90,
     92,    96,    99,   102,   105,   109,   113,   116,
    120,   124,   128,   133,   137,   142,   146,   151,
    156,   161,   167,   172,   178,   184,   190,   196,
    203,   210,   217,   224,   231,   239,   247,   255
};

short   MLNTab[16] =
    { -6,   -5,   -3,   -1,    4,   11,   19,   26,
      -6,   -5,   -3,   -1,    4,   11,   19,   26 };



/************************************************************************/
/* Calculate delta (n) based upon current step size and sample          */
/************************************************************************/
DltTab (StepIx, sample)
short StepIx, sample;
{
    int retval;

    /********************************************************************/
    /* DltTab = Delta (n) = [+/-] [(nib * 2 + 1) * step]                */
    /********************************************************************/
    retval = (((sample & 0x07) * 2 + 1) * StpTab[StepIx]);

    if ((sample & 0x08) != 0)  retval = -retval;
    return (retval);
}


/************************************************************************/
/* Calculate next step size based upon current step size and sample     */
/************************************************************************/
NxtStp (StepIx, sample)
short StepIx, sample;
{
    /********************************************************************/
    /* NxtStp = Next stepsize index                                     */
    /********************************************************************/
    StepIx = StepIx + MLNTab[sample];
    if (StepIx < 0) StepIx = 0;
    if (StepIx >= STPTABSIZ) StepIx = STPTABSIZ-1;
    return (StepIx);
}


